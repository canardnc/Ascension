<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Pic - Apprends l'Anglais</title>
    <!-- Composant de fin de partie standard -->
    <script src="/js/minigame-utils.js" defer></script>
    <style>
        :root {
            --primary: #4a6ee0;
            --secondary: #e07c4a;
            --correct: #4ae07c;
            --wrong: #e04a4a;
            --background: #f5f7ff;
            --disabled: #cccccc;
        }

        body {
            font-family: 'Comic Neue', 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Arri√®re-plan selon la cat√©gorie */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(3px) brightness(0.8);
            z-index: -1;
        }

        body.strength::before {
            background-image: url('/assets/images/background/training_force.jpeg');
        }

        body.endurance::before {
            background-image: url('/assets/images/background/training_stamina.jpeg');
        }

        body.recovery::before {
            background-image: url('/assets/images/background/training_recovery.jpeg');
        }

        body.agility::before {
            background-image: url('/assets/images/background/training_agility.jpeg');
        }

        .container {
            max-width: 800px;
            width: 95%;
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            z-index: 1;
        }

        h1 {
            color: var(--primary);
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .subtitle {
            color: var(--secondary);
            text-align: center;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        /* Word display */
        .word-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f0ff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .english-word {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-right: 15px;
            text-transform: capitalize;
        }

        .sound-button {
            background: none;
            border: none;
            color: var(--secondary);
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .sound-button:hover {
            transform: scale(1.2);
        }

        /* Image grid */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .image-option {
            width: 100%;
            aspect-ratio: 1/1; /* Aspect ratio carr√© */
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #ddd;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px;
            object-fit: contain;
        }

        .image-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-color: var(--primary);
        }

        .image-option.correct {
            border-color: var(--correct);
            pointer-events: none;
        }

        .image-option.wrong {
            border-color: var(--wrong);
            opacity: 0.7;
            pointer-events: none;
        }

        .image-option.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .feedback-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.5rem;
            filter: drop-shadow(0 0 2px white);
        }

        /* Progress bar */
        .progress-container {
            margin-top: 15px;
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.5s;
        }

        /* Stats and controls */
        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .timer-display {
            font-weight: bold;
            color: var(--secondary);
        }

        /* Navigation buttons */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .nav-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            background-color: #3a5ec0;
        }

        /* Modal d'√©nergie insuffisante */
        .energy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        .energy-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .energy-error-message {
            color: var(--wrong);
            font-size: 18px;
            margin-bottom: 20px;
        }

        .energy-back-button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        /* Next question button */
        .next-question-btn {
            display: none;
            margin: 15px auto;
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .next-question-btn:hover {
            transform: translateY(-2px);
        }

        /* Loading indicator */
        .loading-indicator {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: var(--primary);
        }

        /* Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                width: 90%;
                padding: 10px;
            }
            
            .english-word {
                font-size: 2rem;
            }
            
            .images-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .image-option {
                height: 100px;
            }
        }

        @media (max-width: 480px) {
            .english-word {
                font-size: 1.8rem;
            }
            
            .sound-button {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body class="strength">
    <div class="container">
        <h1>Word Pic</h1>
        <p class="subtitle">Apprends l'anglais en t'amusant !</p>

        <!-- Word display area -->
        <div class="word-container">
            <div class="english-word" id="current-word">Loading...</div>
            <button class="sound-button" id="sound-button" aria-label="√âcouter la prononciation">üîä</button>
        </div>

        <!-- Images grid -->
        <div class="images-grid" id="images-grid">
            <div class="loading-indicator">Chargement des images...</div>
        </div>

        <!-- Next question button -->
        <button class="next-question-btn" id="next-question-btn">Question suivante ‚Üí</button>

        <!-- Progress bar -->
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <!-- Stats -->
        <div class="stats-container">
            <div>Score: <span id="score">0</span></div>
            <div>Temps: <span id="timer" class="timer-display">00:00</span></div>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-button" id="back-button">Quitter</button>
        </div>
    </div>

    <!-- Modal d'√©nergie insuffisante -->
    <div class="energy-modal" id="energy-modal">
        <div class="energy-modal-content">
            <h2>√ânergie Insuffisante</h2>
            <p class="energy-error-message">Tu n'as pas assez d'√©nergie pour jouer √† ce mini-jeu.</p>
            <button class="energy-back-button" id="energy-back-button">Retour √† l'entra√Ænement</button>
        </div>
    </div>

    <script>
        // Configuration du jeu
        const GAME_ID = 3; // ID du mini-jeu
        const QUESTIONS_PER_GAME = 10; // Nombre de questions par partie
        
        // Variables du jeu
        let difficultyLevel = 1;
        let currentQuestionIndex = 0;
        let iconsCollection = [];
        let currentIcon = null;
        let score = 0;
        let waitingForNextQuestion = false;
        
        // Variables pour la synth√®se vocale
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        
        // Variables pour le suivi du temps
        let gameStartTime;
        let currentGameTime = 0;
        let timeInterval;
        
        // Points par difficult√©
        const pointsPerCorrectAnswer = {
            1: 10,  // 10 points par bonne r√©ponse au niveau 1
            2: 15,  // 15 points par bonne r√©ponse au niveau 2
            3: 20   // 20 points par bonne r√©ponse au niveau 3
        };

        // P√©nalit√© par mauvaise r√©ponse
        const pointsPerWrongAnswer = {
            1: 5,   // -5 points par mauvaise r√©ponse au niveau 1
            2: 7,   // -7 points par mauvaise r√©ponse au niveau 2
            3: 10   // -10 points par mauvaise r√©ponse au niveau 3
        };

        // Initialisation
        init();

        function init() {
            // R√©cup√©rer le niveau de difficult√© depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            difficultyLevel = parseInt(urlParams.get('difficulty') || '1');
            
            // Mettre √† jour la classe du corps selon la cat√©gorie
            const category = urlParams.get('category') || 'strength';
            document.body.className = category;

            // Configurer les √©v√©nements
            document.getElementById('back-button').addEventListener('click', exitGame);
            document.getElementById('energy-back-button').addEventListener('click', exitGame);
            document.getElementById('sound-button').addEventListener('click', playCurrentWordSound);
            document.getElementById('next-question-btn').addEventListener('click', nextQuestion);

            // R√©cup√©rer les m√©tadonn√©es du mini-jeu (titre et description)
            loadMinigameMetadata();

            // V√©rifier l'√©nergie et d√©marrer le jeu
            checkEnergyAndStartGame();
        }

        function loadMinigameMetadata() {
            const token = localStorage.getItem('token');
            if (!token) return;

            // R√©cup√©rer les m√©tadonn√©es du mini-jeu (GAME_ID = 3)
            fetch(`/api/minigame/metadata?id=${GAME_ID}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => {
                if (!res.ok) throw new Error('Erreur lors du chargement des m√©tadonn√©es');
                return res.json();
            })
            .then(metadata => {
                // Mettre √† jour le titre et la description
                document.querySelector('h1').textContent = metadata.title || "Word Pic";
                document.querySelector('.subtitle').textContent = metadata.description || "Apprends l'anglais en t'amusant !";

                // Ajouter le niveau au titre
                document.querySelector('h1').textContent += ` - Niveau ${difficultyLevel}`;
            })
            .catch(error => {
                console.error('Erreur:', error);
                // Garder le titre et la description par d√©faut en cas d'erreur
            });
        }

        function checkEnergyAndStartGame() {
            const token = localStorage.getItem('token');
            if (!token) {
                showEnergyError();
                return;
            }

            // R√©cup√©rer les statistiques du joueur pour v√©rifier l'√©nergie
            fetch('/api/player/stats', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => {
                if (!res.ok) throw new Error('Erreur r√©seau');
                return res.json();
            })
            .then(data => {
                // Calculer le co√ªt en √©nergie (nous utilisons 1 par d√©faut pour ce mini-jeu)
                const energyCost = 1;
                
                if (data.currentEnergy < energyCost) {
                    showEnergyError();
                } else {
                    // D√©duire l'√©nergie (cette op√©ration est g√©r√©e c√¥t√© serveur)
                    // Nous lan√ßons simplement le jeu
                    loadIcons();
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showEnergyError();
            });
        }

        function showEnergyError() {
            document.getElementById('energy-modal').style.display = 'flex';
        }

        function loadIcons() {
            const token = localStorage.getItem('token');
            if (!token) {
                showEnergyError();
                return;
            }

            // Nombre d'ic√¥nes √† charger (plus que n√©cessaire pour avoir des options diverses)
            const iconsToLoad = QUESTIONS_PER_GAME * 5;

            // R√©cup√©rer les ic√¥nes al√©atoires de la base de donn√©es
            fetch(`/api/icons/random?count=${iconsToLoad}&difficulty=${difficultyLevel}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => {
                if (!res.ok) throw new Error('Erreur lors du chargement des ic√¥nes');
                return res.json();
            })
            .then(icons => {
                if (!icons || icons.length < QUESTIONS_PER_GAME) {
                    throw new Error('Pas assez d\'ic√¥nes disponibles');
                }
                
                // Traiter les ic√¥nes re√ßues
                iconsCollection = icons.map(icon => {
                    console.log("Ic√¥ne re√ßue:", icon);
                    
                    // D√©terminons quel champ contient r√©ellement le mot anglais
                    // Examinons toutes les propri√©t√©s pour comprendre la structure
                    const allProps = Object.keys(icon).join(', ');
                    console.log(`Propri√©t√©s disponibles: ${allProps}`);
                    
                    // Le mot anglais se trouve dans la propri√©t√© englishWord, mais ajoutons d'autres options au cas o√π
                    const englishWord = icon.englishWord || icon.EnglishWord || icon.description_en || 
                                       // Fallback: utiliser le nom de fichier comme derni√®re option
                                       icon.filename.split('.')[0].replace(/_/g, ' ');
                    
                    console.log(`Mot anglais d√©tect√©: ${englishWord}`);
                    console.log(`Description (FR): ${icon.description}`);
                    
                    return {
                        id: icon.id,
                        filename: icon.filename,
                        type: icon.type,
                        description: icon.description,
                        englishWord: englishWord,
                        // Le chemin d'acc√®s √† l'image
                        imagePath: `/assets/images/icons/${icon.filename}`
                    };
                });
                
                console.log("Ic√¥nes trait√©es:", iconsCollection);
                
                startGame();
            })
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('images-grid').innerHTML = `
                    <div style="text-align: center; color: red; padding: 20px;">
                        Erreur lors du chargement des ic√¥nes. Veuillez r√©essayer.
                    </div>
                `;
            });
        }

        function startGame() {
            // M√©langer les ic√¥nes et prendre le nombre n√©cessaire pour le jeu
            const shuffledIcons = shuffleArray(iconsCollection);
            iconsCollection = shuffledIcons.slice(0, QUESTIONS_PER_GAME * 5);

            // Initialiser les variables
            currentQuestionIndex = 0;
            score = 0;
            document.getElementById('score').textContent = score;
            updateProgressBar();

            // Enregistrer l'heure de d√©but et d√©marrer le chronom√®tre
            gameStartTime = new Date();
            currentGameTime = 0;
            startTimer();

            // D√©marrer avec la premi√®re question
            showNextQuestion();
        }

        function startTimer() {
            // Afficher le temps initial
            updateTimerDisplay();
            
            // D√©marrer le chronom√®tre
            timeInterval = setInterval(() => {
                currentGameTime++;
                updateTimerDisplay();
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentGameTime / 60);
            const seconds = currentGameTime % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function showNextQuestion() {
            // V√©rifier si toutes les questions ont √©t√© pos√©es
            if (currentQuestionIndex >= QUESTIONS_PER_GAME) {
                endGame();
                return;
            }
            
            // Cacher le bouton "Question suivante"
            document.getElementById('next-question-btn').style.display = 'none';
            
            // S√©lectionner une ic√¥ne al√©atoire parmi la collection
            const availableIcons = iconsCollection.filter(icon => 
                !icon.used || icon.used === false
            );
            
            if (availableIcons.length === 0) {
                endGame();
                return;
            }
            
            // S√©lectionner une ic√¥ne al√©atoire
            const randomIndex = Math.floor(Math.random() * availableIcons.length);
            currentIcon = availableIcons[randomIndex];
            
            // Marquer l'ic√¥ne comme utilis√©e
            currentIcon.used = true;
            
            // D√©boguer pour voir ce qui se passe
            console.log("Mot anglais √† afficher:", currentIcon.englishWord);
            
            // Mettre √† jour le mot affich√©
            const currentWordElement = document.getElementById('current-word');
            currentWordElement.textContent = currentIcon.englishWord || "No word found";
            
            // Prononcer le mot automatiquement
            playCurrentWordSound();
            
            // S√©lectionner 3 ic√¥nes al√©atoires diff√©rentes de l'ic√¥ne actuelle
            let optionsPool = iconsCollection.filter(icon => icon.id !== currentIcon.id);
            optionsPool = shuffleArray(optionsPool).slice(0, 3);
            
            // Ajouter l'ic√¥ne actuelle et m√©langer les options
            const allOptions = shuffleArray([currentIcon, ...optionsPool]);
            
            // Cr√©er la grille d'images
            createImagesGrid(allOptions);
            
            // Mettre √† jour la barre de progression
            updateProgressBar();
        }

        function createImagesGrid(options) {
            const gridContainer = document.getElementById('images-grid');
            gridContainer.innerHTML = '';
            
            // Cr√©er un √©l√©ment pour chaque option
            options.forEach(option => {
                // Cr√©er directement l'image avec la classe appropri√©e
                const img = document.createElement('img');
                img.src = option.imagePath;
                img.alt = option.description || option.englishWord;
                img.className = 'image-option';
                img.dataset.id = option.id;
                
                // Ajouter un gestionnaire d'erreur pour les images qui ne se chargent pas
                img.onerror = function() {
                    console.log(`Erreur de chargement pour l'image: ${option.imagePath}`);
                    img.src = `https://dummyimage.com/200x200/3498db/ffffff&text=${encodeURIComponent(option.englishWord)}`;
                };
                
                // Ajouter un gestionnaire d'√©v√©nement pour le clic
                img.addEventListener('click', () => handleImageClick(img));
                
                gridContainer.appendChild(img);
            });
        }

        function handleImageClick(imageElement) {
    // Si on attend d√©j√† la prochaine question, ignorer
    if (waitingForNextQuestion) return;
    
    const selectedId = parseInt(imageElement.dataset.id);
    const isCorrect = selectedId === currentIcon.id;
    
    if (isCorrect) {
        // Bonne r√©ponse
        imageElement.classList.add('correct');
        
        // Ajouter des points
        score += pointsPerCorrectAnswer[difficultyLevel];
        document.getElementById('score').textContent = score;
        
        // D√©sactiver toutes les autres options
        document.querySelectorAll('.image-option').forEach(option => {
            if (option !== imageElement) {
                option.classList.add('disabled');
            }
        });
    } else {
        // Mauvaise r√©ponse
        imageElement.classList.add('wrong');
        
        // Soustraire des points (sans aller en dessous de z√©ro)
        score = Math.max(0, score - pointsPerWrongAnswer[difficultyLevel]);
        document.getElementById('score').textContent = score;
        
        // Trouver et mettre en √©vidence la bonne r√©ponse
        document.querySelectorAll('.image-option').forEach(option => {
            if (parseInt(option.dataset.id) === currentIcon.id) {
                option.classList.add('correct');
            } else if (option !== imageElement) {
                option.classList.add('disabled');
            }
        });
    }
    
    // Attendre avant d'afficher le bouton pour la question suivante
    waitingForNextQuestion = true;
    setTimeout(() => {
        document.getElementById('next-question-btn').style.display = 'block';
    }, 1500);
}

        function nextQuestion() {
            // Passer √† la question suivante
            currentQuestionIndex++;
            waitingForNextQuestion = false;
            showNextQuestion();
        }

        function playCurrentWordSound() {
            // Arr√™ter toute prononciation en cours
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // S'assurer qu'il y a un mot √† prononcer
            if (!currentIcon || !currentIcon.englishWord) {
                console.error("Pas de mot √† prononcer:", currentIcon);
                return;
            }
            
            console.log("Prononciation du mot:", currentIcon.englishWord);
            
            // Cr√©er un nouvel objet de prononciation
            speechUtterance = new SpeechSynthesisUtterance(currentIcon.englishWord);
            speechUtterance.lang = 'en-US';
            speechUtterance.rate = 0.8; // Ralentir l√©g√®rement pour plus de clart√©
            
            // Prononcer le mot
            speechSynthesis.speak(speechUtterance);
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const progress = (currentQuestionIndex / QUESTIONS_PER_GAME) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function getMaxPossibleScore() {
            return QUESTIONS_PER_GAME * pointsPerCorrectAnswer[difficultyLevel];
        }

        function getGameDuration() {
            return currentGameTime;
        }

        function resetGame() {
            // Arr√™ter le timer
            clearInterval(timeInterval);
            
            // R√©initialiser les variables
            currentQuestionIndex = 0;
            score = 0;
            waitingForNextQuestion = false;
            currentGameTime = 0;
            
            // R√©initialiser les ic√¥nes utilis√©es
            iconsCollection.forEach(icon => {
                icon.used = false;
            });
            
            // Mettre √† jour l'affichage
            document.getElementById('score').textContent = score;
            updateTimerDisplay();
            document.getElementById('next-question-btn').style.display = 'none';
            
            // D√©marrer une nouvelle partie
            gameStartTime = new Date();
            startTimer();
            showNextQuestion();
        }

        function endGame() {
            // Arr√™ter le timer
            clearInterval(timeInterval);
            
            // Appeler le composant standardis√© de fin de partie
            showEndgameScreen(
                score,                  // Score obtenu
                getMaxPossibleScore(),  // Score maximum possible
                document.body.className, // Cat√©gorie du mini-jeu bas√©e sur la classe du body
                resetGame,              // Fonction pour r√©initialiser le jeu
                {
                    minigameId: GAME_ID,        // ID du mini-jeu
                    difficultyLevel: difficultyLevel,
                    timeSpent: getGameDuration() // Temps en secondes
                }
            );
        }

        function exitGame() {
            window.location.href = `/training.html?type=${document.body.className}`;
        }
    </script>
</body>
</html>